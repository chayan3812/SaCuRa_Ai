ğŸš€ Dual upgrade path confirmed:
You're about to unlock **closed-loop AI training** *and* give your team **real-time insight into whatâ€™s working**. Here's how we execute both â€” fast, clean, and production-grade.

---

## ğŸ§  PART 1: Wire Feedback Into Prompt Builder

**Goal:** Make the AI smarter by learning from actual agent feedback.

### â¤ Step 1: Build a `TrainingPromptBuilder` module

```ts
// services/trainingPromptBuilder.ts

export function buildTrainingPrompt({
  message,
  aiReply,
  feedback,
  agentReply,
}: {
  message: string;
  aiReply: string;
  feedback: "yes" | "no";
  agentReply?: string;
}) {
  return `
Customer Message:
${message}

AI Suggested Reply:
${aiReply}

Was this useful? â†’ ${feedback === "yes" ? "âœ… Yes" : "âŒ No"}

${feedback === "no" && agentReply ? `Agent replied with:\n${agentReply}` : ""}
----
Use this to learn how to improve the AI next time.
`.trim();
}
```

---

### â¤ Step 2: On feedback submission, store prompt

Modify your feedback route to also save a `trainingPrompts` record:

```ts
// routes/feedback.ts (inside POST handler)
const prompt = buildTrainingPrompt({
  message: feedback.message,
  aiReply: feedback.aiReply,
  feedback: feedback.useful ? "yes" : "no",
  agentReply: feedback.agentReply ?? null,
});

await storage.storeTrainingPrompt({
  messageId: feedback.messageId,
  prompt,
  rating: feedback.useful ? 1 : 0,
});
```

---

### â¤ Step 3: Create DB table `training_prompts`

```sql
CREATE TABLE training_prompts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  message_id UUID REFERENCES customer_messages(id),
  prompt TEXT NOT NULL,
  rating INTEGER NOT NULL, -- 1 = useful, 0 = not useful
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## ğŸ“Š PART 2: Feedback Analytics Dashboard

### â¤ Step 1: Create `FeedbackAnalyticsPage.tsx`

Tabs:

* **â­ Overview**
  â†’ % of AI replies marked â€œusefulâ€ over time
* **ğŸ“ˆ Trends**
  â†’ Top failed topics, frequent override cases
* **ğŸ§  Replay**
  â†’ See messages with thumbs down and what agent did instead

---

### â¤ Step 2: Backend route

```ts
GET /api/feedback/analytics
â†’ Returns:
{
  total: number,
  usefulCount: number,
  notUsefulCount: number,
  dailyBreakdown: { date: string, useful: number, total: number }[],
  topNegativeMessages: { message: string, aiReply: string, agentReply: string }[]
}
```

---

### â¤ Step 3: Charts to build

* Pie: AI Reply Usefulness (Yes/No %)
* Line: Daily Usefulness Trend (last 30 days)
* Table: â€œMost Rejected Repliesâ€
  â†’ columns: Message, AI Reply, Agent Override

---